name: CI Pipeline
on:
  push:
    branches:
      - main
jobs:
  RunMake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential dpkg git cmake libcurl4-openssl-dev

      - name: Install prometheus-cpp
        run: |
          git clone https://github.com/jupp0r/prometheus-cpp.git
          cd prometheus-cpp
          git submodule init
          git submodule update
          mkdir build && cd build
          cmake .. -DBUILD_SHARED_LIBS=ON
          make -j 4
          sudo make install
          sudo ldconfig

      - name: Run Make
        run: |
          cd src
          make || { echo "Make failed"; exit 1; }
          ls -l
          mkdir -p ../artifacts
          cp ../usr/bin/fibonacci ../artifacts/ || { echo "Failed to copy fibonacci to artifacts"; exit 1; }

      - name: Upload Artifact (Binary)
        uses: actions/upload-artifact@v4
        with:
          name: fibonacci-binary
          path: artifacts/

  RunTest:
    needs: RunMake
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Install runtime dependencies
        run: |
          sudo apt update
          sudo apt install -y libcurl4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: fibonacci-binary
          path: artifacts/

      - name: Run Tests
        run: |
          chmod +x artifacts/fibonacci
          echo "Testing fibonacci binary..."
          # Тестируем что бинарник запускается (бесконечный цикл с метриками)
          timeout 5s artifacts/fibonacci || exit 0
          echo "Binary executed successfully"

  RunPackage:
    needs: RunTest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: fibonacci-binary
          path: artifacts/

      - name: Install packaging dependencies
        run: sudo apt install -y dpkg-dev

      - name: Create Debian Package
        run: |
          mkdir -p artifacts/deb/usr/local/bin
          mkdir -p artifacts/deb/DEBIAN
          # Убедитесь что файл DEBIAN/control существует в репозитории
          cp DEBIAN/control artifacts/deb/DEBIAN/ || echo "Using default control file"
          # Если файла control нет, создаем его
          if [ ! -f artifacts/deb/DEBIAN/control ]; then
            cat > artifacts/deb/DEBIAN/control << EOF
          Package: fibonacci
          Version: 1.0-1
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libcurl4
          Maintainer: Your Name <your.email@example.com>
          Description: Fibonacci number calculator with Prometheus metrics
          EOF
          fi
          cp artifacts/fibonacci artifacts/deb/usr/local/bin/
          dpkg-deb --build artifacts/deb fibonacci.deb

      - name: Upload Debian Package
        uses: actions/upload-artifact@v4
        with:
          name: fibonacci-deb
          path: fibonacci.deb

  RunDeploy:
    needs: RunPackage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Debian Package Artifact
        uses: actions/download-artifact@v4
        with:
          name: fibonacci-deb
          path: ./

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: salt1s/fibonacci:latest