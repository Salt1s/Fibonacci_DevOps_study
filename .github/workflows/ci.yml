name: CI Pipeline
on:
  push:
    branches:
      - main
jobs:
  RunMake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential g++ cmake git libcurl4-openssl-dev

      - name: Install Prometheus C++ Client
        run: |
          git clone --recursive https://github.com/jupp0r/prometheus-cpp.git
          cd prometheus-cpp
          mkdir build && cd build
          cmake .. -DBUILD_SHARED_LIBS=ON -DENABLE_BENCHMARK=OFF -DCMAKE_INSTALL_PREFIX=/usr
          make -j$(nproc)
          sudo make install
          sudo ldconfig  # Обновляем кэш ldconfig

      - name: Verify Prometheus C++ Client Installation
        run: |
          find /usr/lib -name "libprometheus-cpp*" || echo "Library not found!"
          ldconfig -p | grep prometheus-cpp || echo "Library not found in ldconfig!"

      - name: Build Project
        run: |
          cd src
          make || { echo "Make failed"; exit 1; }
          mkdir -p ../artifacts  # Создаем папку для артефактов
          cp fibonacci ../artifacts/  # Копируем бинарный файл в папку artifacts
          ls -l ../artifacts  # Проверяем, что файл скопирован
          mkdir -p ../usr/bin
          cp fibonacci ../usr/bin/  # Копируем бинарный файл в папку usr/bin
          rm -f fibonacci  # Удаляем файл после копирования

      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fibonacci-binary
          path: artifacts/fibonacci

  RunTest:
    needs: RunMake
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Install runtime dependencies
        run: |
          sudo apt update
          sudo apt install -y libcurl4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: fibonacci-binary
          path: artifacts/

      - name: Run Tests
        run: |
          chmod +x artifacts/fibonacci
          echo "Testing fibonacci binary..."
          # Тестируем что бинарник запускается (бесконечный цикл с метриками)
          timeout 5s artifacts/fibonacci || exit 0
          echo "Binary executed successfully"

  RunPackage:
    needs: RunTest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: fibonacci-binary
          path: artifacts/

      - name: Install packaging dependencies
        run: sudo apt install -y dpkg-dev

      - name: Create Debian Package
        run: |
          mkdir -p artifacts/deb/usr/local/bin
          mkdir -p artifacts/deb/DEBIAN
          # Убедитесь что файл DEBIAN/control существует в репозитории
          cp DEBIAN/control artifacts/deb/DEBIAN/ || echo "Using default control file"
          # Если файла control нет, создаем его
          if [ ! -f artifacts/deb/DEBIAN/control ]; then
            cat > artifacts/deb/DEBIAN/control << EOF
          Package: fibonacci
          Version: 1.0-1
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libcurl4
          Maintainer: Your Name <your.email@example.com>
          Description: Fibonacci number calculator with Prometheus metrics
          EOF
          fi
          cp artifacts/fibonacci artifacts/deb/usr/local/bin/
          dpkg-deb --build artifacts/deb fibonacci.deb

      - name: Upload Debian Package
        uses: actions/upload-artifact@v4
        with:
          name: fibonacci-deb
          path: fibonacci.deb

  RunDeploy:
    needs: RunPackage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Debian Package Artifact
        uses: actions/download-artifact@v4
        with:
          name: fibonacci-deb
          path: ./

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: salt1s/fibonacci:latest